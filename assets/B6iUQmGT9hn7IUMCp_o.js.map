{"version":3,"file":"B6iUQmGT9hn7IUMCp_o.js","names":[],"sources":["../../app/components/ltAllMap.vue","../../app/components/ltAllMap.vue"],"sourcesContent":["<template>\n  <div ref=\"mapRef\" class=\"map h-100\" style=\"min-height: 300px\"></div>\n</template>\n\n<script setup lang=\"ts\">\nimport {type App, createApp, onMounted, reactive, ref} from 'vue';\nimport {useRouter} from 'vue-router';\nimport * as L from 'leaflet';\nimport * as ltData from '../api/ltData';\nimport {useLeafletMap} from './useLeafletMap';\nimport {t} from './useI18n';\nimport {useAppTitle, routeTitlePart} from './useAppTitle';\nimport LtGalleryCard from './ltGalleryCard.vue';\nimport type {CommonsFile} from '../model';\nimport {useLtRoute} from './useLtRoute';\n\nconst {$query, hasFilesUserCategory} = useLtRoute();\nconst $router = useRouter();\nconst mapRef = ref<HTMLElement | null>(null);\n\nuseAppTitle(routeTitlePart(), t('Map'));\n\nonMounted(async () => {\n  const {map} = useLeafletMap(mapRef);\n  if (hasFilesUserCategory.value) {\n    const titles = await ltData.getFiles($query.value);\n    const files = await ltData.getCoordinates(titles);\n    const bounds = files.flatMap(title => {\n      const marker = buildMarker(title);\n      marker?.addTo(map);\n      return marker ? [marker.getLatLng()] : [];\n    });\n    map.fitBounds(bounds);\n  } else {\n    geosearch(map);\n    map.on('moveend', () => geosearch(map));\n    map.on('zoomend', () => geosearch(map));\n  }\n});\n\nasync function geosearch(map: L.Map) {\n  const files = await ltData.geosearch(map.getBounds());\n  map.eachLayer(l => {\n    if (l instanceof L.CircleMarker && !l.isPopupOpen()) {\n      map.removeLayer(l);\n    }\n  });\n  files.forEach(f => buildMarker(f)?.addTo(map));\n}\n\nfunction buildMarker(title: CommonsFile): L.CircleMarker | undefined {\n  if (!title.coordinates.isDefined) return;\n  const {lat, lng} = title.coordinates;\n  return new L.CircleMarker({lat, lng}, {color: '#2a4b8d'})\n    .bindTooltip(title.file)\n    .bindPopup(buildPopup(title));\n}\n\nfunction buildPopup(title: CommonsFile): L.Popup {\n  let app: App;\n  let div: HTMLDivElement;\n  const popup = new L.Popup({minWidth: 400});\n  popup.setContent(() => {\n    title = reactive(title);\n    title.$geolocate = $router.resolve({\n      name: 'geolocate',\n      query: {files: title.file}\n    }).href;\n    app = createApp(LtGalleryCard, {title});\n    ltData.getFileDetails(title.pageid, 'categories|imageinfo', 'extmetadata').then(fileDetails => {\n      Object.assign(title, fileDetails);\n    });\n    div = document.createElement('div');\n    return div;\n  });\n  popup.on('add', () => app.mount(div));\n  popup.on('remove', () => app.unmount());\n  return popup;\n}\n</script>\n\n<style scoped>\n.map {\n  margin-left: calc(var(--bs-gutter-x) * -0.5);\n  margin-right: calc(var(--bs-gutter-x) * -0.5);\n}\n:deep(.leaflet-popup-content-wrapper) {\n  background-color: var(--bs-body-bg);\n}\n:deep(.leaflet-popup-content) {\n  margin: 0.5rem;\n}\n</style>\n","<template>\n  <div ref=\"mapRef\" class=\"map h-100\" style=\"min-height: 300px\"></div>\n</template>\n\n<script setup lang=\"ts\">\nimport {type App, createApp, onMounted, reactive, ref} from 'vue';\nimport {useRouter} from 'vue-router';\nimport * as L from 'leaflet';\nimport * as ltData from '../api/ltData';\nimport {useLeafletMap} from './useLeafletMap';\nimport {t} from './useI18n';\nimport {useAppTitle, routeTitlePart} from './useAppTitle';\nimport LtGalleryCard from './ltGalleryCard.vue';\nimport type {CommonsFile} from '../model';\nimport {useLtRoute} from './useLtRoute';\n\nconst {$query, hasFilesUserCategory} = useLtRoute();\nconst $router = useRouter();\nconst mapRef = ref<HTMLElement | null>(null);\n\nuseAppTitle(routeTitlePart(), t('Map'));\n\nonMounted(async () => {\n  const {map} = useLeafletMap(mapRef);\n  if (hasFilesUserCategory.value) {\n    const titles = await ltData.getFiles($query.value);\n    const files = await ltData.getCoordinates(titles);\n    const bounds = files.flatMap(title => {\n      const marker = buildMarker(title);\n      marker?.addTo(map);\n      return marker ? [marker.getLatLng()] : [];\n    });\n    map.fitBounds(bounds);\n  } else {\n    geosearch(map);\n    map.on('moveend', () => geosearch(map));\n    map.on('zoomend', () => geosearch(map));\n  }\n});\n\nasync function geosearch(map: L.Map) {\n  const files = await ltData.geosearch(map.getBounds());\n  map.eachLayer(l => {\n    if (l instanceof L.CircleMarker && !l.isPopupOpen()) {\n      map.removeLayer(l);\n    }\n  });\n  files.forEach(f => buildMarker(f)?.addTo(map));\n}\n\nfunction buildMarker(title: CommonsFile): L.CircleMarker | undefined {\n  if (!title.coordinates.isDefined) return;\n  const {lat, lng} = title.coordinates;\n  return new L.CircleMarker({lat, lng}, {color: '#2a4b8d'})\n    .bindTooltip(title.file)\n    .bindPopup(buildPopup(title));\n}\n\nfunction buildPopup(title: CommonsFile): L.Popup {\n  let app: App;\n  let div: HTMLDivElement;\n  const popup = new L.Popup({minWidth: 400});\n  popup.setContent(() => {\n    title = reactive(title);\n    title.$geolocate = $router.resolve({\n      name: 'geolocate',\n      query: {files: title.file}\n    }).href;\n    app = createApp(LtGalleryCard, {title});\n    ltData.getFileDetails(title.pageid, 'categories|imageinfo', 'extmetadata').then(fileDetails => {\n      Object.assign(title, fileDetails);\n    });\n    div = document.createElement('div');\n    return div;\n  });\n  popup.on('add', () => app.mount(div));\n  popup.on('remove', () => app.unmount());\n  return popup;\n}\n</script>\n\n<style scoped>\n.map {\n  margin-left: calc(var(--bs-gutter-x) * -0.5);\n  margin-right: calc(var(--bs-gutter-x) * -0.5);\n}\n:deep(.leaflet-popup-content-wrapper) {\n  background-color: var(--bs-body-bg);\n}\n:deep(.leaflet-popup-content) {\n  margin: 0.5rem;\n}\n</style>\n"],"mappings":"8ZCgBA,GAAM,CAAC,SAAQ,wBAAwB,GAAY,CAC7C,EAAU,GAAW,CACrB,EAAS,EAAwB,KAAK,CAE5C,EAAY,GAAgB,CAAE,EAAE,MAAM,CAAC,CAEvC,EAAU,SAAY,CACpB,GAAM,CAAC,OAAO,EAAc,EAAO,CACnC,GAAI,EAAqB,MAAO,CAG9B,IAAM,GADQ,MAAM,EADL,MAAM,EAAgB,EAAO,MAAM,CACD,EAC5B,QAAQ,GAAS,CACpC,IAAM,EAAS,EAAY,EAAM,CAEjC,OADA,GAAQ,MAAM,EAAI,CACX,EAAS,CAAC,EAAO,WAAW,CAAC,CAAG,EAAE,EACzC,CACF,EAAI,UAAU,EAAO,MAErB,EAAU,EAAI,CACd,EAAI,GAAG,cAAiB,EAAU,EAAI,CAAC,CACvC,EAAI,GAAG,cAAiB,EAAU,EAAI,CAAC,EAEzC,CAEF,eAAe,EAAU,EAAY,CACnC,IAAM,EAAQ,MAAM,EAAiB,EAAI,WAAW,CAAC,CACrD,EAAI,UAAU,GAAK,CACb,aAAa,EAAE,cAAgB,CAAC,EAAE,aAAa,EACjD,EAAI,YAAY,EAAE,EAEpB,CACF,EAAM,QAAQ,GAAK,EAAY,EAAE,EAAE,MAAM,EAAI,CAAC,CAGhD,SAAS,EAAY,EAAgD,CACnE,GAAI,CAAC,EAAM,YAAY,UAAW,OAClC,GAAM,CAAC,MAAK,OAAO,EAAM,YACzB,OAAO,IAAI,EAAE,aAAa,CAAC,MAAK,MAAI,CAAE,CAAC,MAAO,UAAU,CAAA,CACrD,YAAY,EAAM,KAAI,CACtB,UAAU,EAAW,EAAM,CAAC,CAGjC,SAAS,EAAW,EAA6B,CAC/C,IAAI,EACA,EACE,EAAQ,IAAI,EAAE,MAAM,CAAC,SAAU,IAAI,CAAC,CAgB1C,OAfA,EAAM,gBACJ,EAAQ,EAAS,EAAM,CACvB,EAAM,WAAa,EAAQ,QAAQ,CACjC,KAAM,YACN,MAAO,CAAC,MAAO,EAAM,KAAI,CAC1B,CAAC,CAAC,KACH,EAAM,EAAU,EAAe,CAAC,QAAM,CAAC,CACvC,EAAsB,EAAM,OAAQ,uBAAwB,cAAc,CAAC,KAAK,GAAe,CAC7F,OAAO,OAAO,EAAO,EAAY,EACjC,CACF,EAAM,SAAS,cAAc,MAAM,CAC5B,GACP,CACF,EAAM,GAAG,UAAa,EAAI,MAAM,EAAI,CAAC,CACrC,EAAM,GAAG,aAAgB,EAAI,SAAS,CAAC,CAChC,oBA5EP,EAAoE,MAAA,SAA3D,SAAJ,IAAI,EAAS,MAAM,YAAY,MAAA,CAAA,aAAA,QAAyB"}